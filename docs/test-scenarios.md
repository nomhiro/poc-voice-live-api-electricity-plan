# 稼働確認テスト - 会話サンプル

電力会社カスタマーサポートシステムの稼働確認テスト用シナリオです。

## テスト環境

- **デフォルト顧客**: 野村宏樹（C-001）
- **電話番号下4桁**: 5678
- **現在のプラン**: 従量電灯B（40A）

---

## シナリオ1: 本人確認と請求金額の確認

### 目的
`get_customer_info` と `get_billing_history` の動作確認

### 会話例

```
👤 ユーザー: 「先月の電気代を教えてください」

🤖 AI: 「かしこまりました。お客様確認をさせていただきます。
        お客様番号、または登録されているお電話番号の下4桁をお教えいただけますか？」

👤 ユーザー: 「5678です」

🤖 AI: 「ありがとうございます。ご本人様確認のため、ご契約者様のお名前をお教えください。」

👤 ユーザー: 「野村です」

🤖 AI: 「野村宏樹様、ご本人様確認が取れました。
        先月のご請求内容を確認いたします。」
        
        [get_customer_info が呼ばれる]
        [get_billing_history が呼ばれる]

🤖 AI: 「○月分の電気料金は○○円でございます。
        内訳は、基本料金が1,180円、従量料金が○○円、
        燃料費調整額がマイナス○○円、再エネ賦課金が○○円です。
        ご使用量は○○キロワットアワーでした。
        他にご不明な点はございますか？」
```

### 確認ポイント
- [ ] 本人確認のフローが正しく動作する
- [ ] 請求金額が正しく表示される
- [ ] 内訳（基本料金、従量料金等）が説明される

---

## シナリオ2: 今月の使用量確認

### 目的
`get_current_usage` の動作確認（スマートメーター対応）

### 会話例

```
👤 ユーザー: 「今月の使用量を教えて」

🤖 AI: 「今月の電力使用量を確認いたします。
        お客様番号をお教えください。」

👤 ユーザー: 「C-001です」

🤖 AI: 「ご契約者様のお名前をお教えください。」

👤 ユーザー: 「野村宏樹です」

        [get_customer_info が呼ばれる]
        [get_current_usage が呼ばれる]

🤖 AI: 「○月○日時点での使用量は○○キロワットアワーです。
        このペースですと、今月の予想使用量は○○キロワットアワー、
        予想料金は約○○円になります。
        先月の同時期と比べると約○%少ないご使用量です。
        他にご不明な点はございますか？」
```

### 確認ポイント
- [ ] 今月の累計使用量が表示される
- [ ] 月末予測が表示される
- [ ] 前月比較が表示される

---

## シナリオ3: スマートメーター非対応の場合

### 目的
スマートメーター非対応時のエラーハンドリング確認

### 会話例（鈴木一郎: C-003 はスマートメーター非対応）

```
👤 ユーザー: 「今月の使用量を教えてください」

🤖 AI: 「お客様番号をお教えください。」

👤 ユーザー: 「2222」

🤖 AI: 「ご契約者様のお名前をお教えください。」

👤 ユーザー: 「鈴木」

        [get_customer_info が呼ばれる]
        [get_current_usage が呼ばれる → エラー]

🤖 AI: 「申し訳ございません。鈴木一郎様のご契約では、
        スマートメーターが設置されていないため、
        リアルタイムの使用量は確認できません。
        次回の検針日以降に請求書でご確認ください。
        他にご不明な点はございますか？」
```

### 確認ポイント
- [ ] スマートメーター非対応のエラーが適切に処理される
- [ ] ユーザーに分かりやすいメッセージが表示される

---

## シナリオ4: 契約可能プランの確認

### 目的
`list_available_plans` の動作確認

### 会話例

```
👤 ユーザー: 「どんなプランがありますか？」

🤖 AI: 「現在ご契約いただけるプランをご案内いたします。」

        [list_available_plans が呼ばれる]

🤖 AI: 「現在、以下の4つのプランをご用意しております。

        1. 従量電灯B - 一般家庭向けの標準プランです。
        2. スマートエコプラン - 夜間の電気料金がお得になるプランです。
        3. グリーンプラスプラン - 再生可能エネルギー100%のプランです。
        4. ファミリーバリュープラン - 使用量が多いご家庭向けのプランです。
        
        詳しくお聞きになりたいプランはございますか？」
```

### 確認ポイント
- [ ] 4つのプランが一覧表示される
- [ ] 各プランの特徴が簡潔に説明される

---

## シナリオ5: プラン変更シミュレーション

### 目的
`simulate_plan_change` の動作確認

### 会話例

```
👤 ユーザー: 「もっと安いプランはありますか？」

🤖 AI: 「お客様に合ったプランをお調べいたします。
        まず、現在のご契約内容を確認させてください。
        お客様番号をお教えください。」

👤 ユーザー: 「5678」

🤖 AI: 「ご契約者様のお名前をお教えください。」

👤 ユーザー: 「野村」

        [get_customer_info が呼ばれる]
        [list_available_plans が呼ばれる]

🤖 AI: 「野村宏樹様、現在は従量電灯Bでご契約いただいております。
        お客様の使用実績を拝見すると、ファミリーバリュープランに
        変更されるとお安くなる可能性があります。
        詳しいシミュレーションをご希望されますか？」

👤 ユーザー: 「お願いします」

        [simulate_plan_change が呼ばれる]

🤖 AI: 「過去の使用実績でシミュレーションいたしました。
        現在のプランでは年間約○○円のところ、
        ファミリーバリュープランでは約○○円となり、
        年間約○○円、月平均○○円ほどお安くなる見込みです。
        
        なお、このプランには12ヶ月の最低契約期間がございます。
        プランの変更をご希望されますか？」
```

### 確認ポイント
- [ ] 過去の使用量に基づいたシミュレーションが表示される
- [ ] 年間・月間の節約額が計算される
- [ ] 最低契約期間などの注意事項が説明される

---

## シナリオ6: プラン変更申請

### 目的
`submit_plan_change_request` の動作確認

### 会話例（シナリオ5の続き）

```
👤 ユーザー: 「変更したいです」

🤖 AI: 「ありがとうございます。プラン変更のお手続きを進めます。
        変更後のファミリーバリュープランは来月の検針日から適用となります。
        また、12ヶ月の最低契約期間がございます。
        途中解約の場合は解約手数料がかかりますが、よろしいでしょうか？」

👤 ユーザー: 「はい、大丈夫です」

        [submit_plan_change_request が呼ばれる]

🤖 AI: 「プラン変更申請を受け付けました。
        申請番号はPCR-C-001-○○○です。
        ○月の検針日からファミリーバリュープランが適用されます。
        確認のメールもお送りしておりますので、ご確認ください。
        他にご不明な点はございますか？」
```

### 確認ポイント
- [ ] お客様の同意確認が行われる
- [ ] 申請が正常に登録される
- [ ] 申請番号が発行される
- [ ] 適用開始日が案内される

---

## シナリオ7: 本人確認失敗のケース

### 目的
本人確認エラー時の動作確認

### 会話例

```
👤 ユーザー: 「電気代を教えてください」

🤖 AI: 「お客様番号をお教えください。」

👤 ユーザー: 「5678」

🤖 AI: 「ご契約者様のお名前をお教えください。」

👤 ユーザー: 「田中です」

        [get_customer_info が呼ばれる → 本人確認失敗]

🤖 AI: 「申し訳ございません。ご本人様確認ができませんでした。
        ご契約者様のお名前をもう一度ご確認いただけますか？」
```

### 確認ポイント
- [ ] 名前が一致しない場合にエラーになる
- [ ] 適切なエラーメッセージが表示される
- [ ] 再入力を促す

---

## シナリオ8: 過去6ヶ月の請求履歴

### 目的
複数月の請求履歴取得確認

### 会話例

```
👤 ユーザー: 「過去半年の電気代を教えてください」

🤖 AI: 「過去6ヶ月分のご請求履歴を確認いたします。
        お客様番号をお教えください。」

👤 ユーザー: 「C-001、野村です」

        [get_customer_info が呼ばれる]
        [get_billing_history(months=6) が呼ばれる]

🤖 AI: 「野村宏樹様、過去6ヶ月分のご請求履歴をご案内いたします。

        ○月: ○○円（○○kWh）
        ○月: ○○円（○○kWh）
        ○月: ○○円（○○kWh）
        ○月: ○○円（○○kWh）
        ○月: ○○円（○○kWh）
        ○月: ○○円（○○kWh）
        
        6ヶ月の平均は○○円、平均使用量は○○キロワットアワーでした。
        他にご不明な点はございますか？」
```

### 確認ポイント
- [ ] 6ヶ月分の履歴が表示される
- [ ] 各月の金額と使用量が表示される
- [ ] 平均値が計算される

---

## クイックテスト用チェックリスト

### API単体テスト（curlコマンド）

```bash
# 1. 顧客情報取得
curl -X POST http://localhost:3000/api/functions/get_customer_info \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001", "verificationName": "野村"}'

# 2. 請求履歴取得
curl -X POST http://localhost:3000/api/functions/get_billing_history \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001", "months": 6}'

# 3. 今月使用量取得
curl -X POST http://localhost:3000/api/functions/get_current_usage \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001"}'

# 4. プラン一覧取得
curl -X POST http://localhost:3000/api/functions/list_available_plans \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001"}'

# 5. プラン変更シミュレーション
curl -X POST http://localhost:3000/api/functions/simulate_plan_change \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001", "newPlanId": "plan-family-value"}'

# 6. プラン変更申請
curl -X POST http://localhost:3000/api/functions/submit_plan_change_request \
  -H "Content-Type: application/json" \
  -d '{"customerId": "C-001", "newPlanId": "plan-family-value", "customerConfirmation": true}'
```

### 音声対話テスト

1. [ ] http://localhost:3000/realtime にアクセス
2. [ ] 「Start」ボタンをクリック
3. [ ] マイクアクセスを許可
4. [ ] 上記シナリオ1〜8を順番に実行
5. [ ] AIの応答が適切か確認

---

## トラブルシューティング

### AIが応答しない場合
- Azure OpenAI の接続設定を確認
- ブラウザの開発者ツールでエラーを確認
- `/api/realtime/session` のレスポンスを確認

### 本人確認が通らない場合
- 顧客ID: `C-001`, `C-002`, `C-003`
- 電話番号下4桁: `5678`, `5432`, `2222`
- 名前は姓のみでもOK（野村、佐藤、鈴木）

### データがない場合
- サンプルデータを投入:
  ```bash
  curl -X POST http://localhost:3000/api/admin/seed-electricity-data
  ```
